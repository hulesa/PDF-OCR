<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>PDF konvertor</title>

  <!-- PDF.js -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>

  <!-- Tesseract.js 4.x -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <style>
    #progress-container { width: 300px; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; }
    #progress-bar { height: 20px; width: 0%; background: #4caf50; transition: width 0.2s; }
    #progress-text { font-size: 14px; margin-top: 5px; }
  </style>
</head>
<body style="font-family:sans-serif; padding:20px;">
  <h2>Převod skenovaného PDF na "živé" PDF</h2>
  <input type="file" id="fileInput" accept="application/pdf"/>
  
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-text">Čekám na soubor...</div>

  <button id="downloadBtn" style="display:none; padding:10px 20px;">Stáhnout PDF</button>

  <script>
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const downloadBtn = document.getElementById('downloadBtn');
    let finalPdfBytes = null;

    // Nastavení workeru pro pdf.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      progressText.textContent = "Načítám PDF...";
      progressBar.style.width = "0%";

      const pdfData = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;

      const { PDFDocument, rgb } = PDFLib;
      const pdfDoc = await PDFDocument.create();

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2.0 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        // OCR – s vizualizací progresu
        const { data } = await Tesseract.recognize(canvas, 'eng', {
          logger: m => {
            if (m.status === "recognizing text") {
              const percent = Math.round(((i-1) + m.progress) / pdf.numPages * 100);
              progressBar.style.width = percent + "%";
              progressText.textContent = `Stránka ${i}/${pdf.numPages} – ${percent}%`;
            }
          }
        });

        const pagePdf = pdfDoc.addPage([viewport.width, viewport.height]);
        const pngImage = await pdfDoc.embedPng(canvas.toDataURL("image/png"));
        pagePdf.drawImage(pngImage, { x: 0, y: 0, width: viewport.width, height: viewport.height });

        // Přidání neviditelného textu
        data.words.forEach(word => {
          const { x0, y0, x1, y1 } = word.bbox;
          pagePdf.drawText(word.text, {
            x: x0,
            y: viewport.height - y1,
            size: y1 - y0,
            color: rgb(1,1,1),
            opacity: 0
          });
        });
      }

      finalPdfBytes = await pdfDoc.save();
      downloadBtn.style.display = "inline-block";
      progressBar.style.width = "100%";
      progressText.textContent = "Hotovo! PDF připraveno ke stažení.";
    });

    downloadBtn.addEventListener('click', () => {
      if (finalPdfBytes) {
        const blob = new Blob([finalPdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "searchable.pdf";
        link.click();
      }
    });
  </script>
</body>
</html>
